<html>
<head>
        <style>
                #neck td {
                    border: 1px solid black;
                    width: 60px;
                    text-align: center;
                    user-select: none;
                }
                .band {
                    background-color: rgb(200, 200, 170);
                }
                .empty {
                    background-color: rgb(120, 120, 90);
                    width: 45px;
                }
                #notes {
                    width: 800px;
                }
                .active {
                    background-color: rgb(200, 256, 200);
                }
                .tabs {
                  font-family: monospace, monospace;
                  padding-bottom: 20px;
                }
                h1 {color: red;}
                p {color: blue;}
              </style>

        <script
        src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
        crossorigin="anonymous"></script>
    <script>

    let ctrlIsPressed = false
    let ctrlIsUsed = false
    $(document).keydown(event => {
      if(event.which === 17) {
        ctrlIsPressed = true
        ctrlIsUsed = false
      }
    })

    $(document).keyup(() => {
      if (ctrlIsPressed) {
         ctrlIsPressed = false
         if (ctrlIsUsed) {
           progPos ++
         }
         render()
      }
    })


    let progression = []
    let progPos = 0

    function add(note, multi) {
      if (multi && ctrlIsPressed) {
        if (progPos >= progression.length) {
          progression.push(note)
        } else {
          progression[progPos] += '+' + note
        }
        ctrlIsUsed = true
        render()
        return
      }

        if (progPos >= progression.length) {
          progression.push(note)
          progPos = progression.length
        } else {
          progression.splice(progPos, 0, note)
          progPos ++
        }

        render()
    }

    function remove() {
      if (progPos < progression.length) {
        progression.splice(progPos, 1)
      }
      render()
    }

    function tabClicked (pos) {
      progPos = pos
      render()
    }

    function tabRequest(success, type, data, id) {
      const opts = {
        type: type,
        url: '/v1/tab',
        contentType: 'application/json',
        dataType: 'json',
        success: success
      }

      if (id) {
        opts.url += '/' + id
      }

      if (data) {
        opts.data = JSON.stringify(data)
      }
      $.ajax(opts)
    }

    function parseNotes() {
        progression.length = 0
        $('#notes').val().replace(/\n/g, ' ').split(' ').forEach(note => {
            if (note != '') {
                if (note === ' ') {
                   note = '-'
                }
                progression.push(note)
            }
        })
        progPos = progression.length
        render()
    }

    const instruments = {
      guitar: ['E4', 'B3', 'G3', 'D3', 'A2', 'E2'],
      mandolin: ['E5', 'A4', 'D4', 'G3'],
      banjo: ['D4', 'B3', 'G3', 'D3', 'G4'],
      bass: ['G2', 'D2', 'A1', 'E1']
    }

    const rawscale = [ 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']
    const scale = []

    let store = {}
    let current = null

    for (let i = 1; i <= 10; i ++) {
        rawscale.forEach(note => scale.push(note + i))
    }

    function refreshTitles() {
        tabRequest(res => {
          store = {}
          $('#existing')
            .find('option')
            .remove()

          res.forEach(t => {
            $('#existing').append($('<option>', { value: t.uuid }).text(t.title))
            store[t.uuid] = t
          })
        }, 'GET')
    }

    function copyPaste() {
      const sel = window.getSelection()
      const a = sel.baseNode.parentElement.id.split('-')[1]
      const b = sel.extentNode.parentElement.id.split('-')[1]

      const start = Math.min(a, b)
      const stop = Math.max(a, b)

      progression.push(...progression.slice(start, stop + 1))
      render()
    }

    $(function() {
        $('#newline').click(() => add('|'))
        $('#space').click(() => add('-'))
        $('#remove').click(() => remove())
        $('#instrument').change(() => render())
        $('#modify').change(() => render())
        $('#notesParse').click(() => parseNotes())
        $('#copy').click(() => copyPaste())

        $('#fetch').click(() => {
          const uuid = $('#existing').val()
          progression = store[uuid].progression.split(' ')
          $('#title').val(store[uuid].title)
          current = store[uuid]
          render()
        })

        $('#save').click(() => {
          if (current === null) {
            tabRequest(data => {
                current = data
                refreshTitles()
              }, 'POST', {
              title: $('#title').val(),
              progression: progression.join(' ')
            })
          } else {
            tabRequest(() => refreshTitles(), 'PUT', {
              title: $('#title').val(),
              progression: progression.join(' ')
            }, current.uuid)
          }
        })

        Object.keys(instruments).forEach(i => {
          $('#instrument').append($('<option>', { value: i }).text(i.replace(/^./, i[0].toUpperCase())))
        })

        refreshTitles()

        const row = $('<tr><td></td></tr>')
        for (let i = 0; i <= 12; i++) {
            row.append($('<td>' + i + '</td>'))
        }
        $('#neck').append(row)

        instruments.guitar.forEach(base => {
            const row = $('<tr><td>' + base + '</td></tr>')
            let neckClass = 'empty'
            for (let i = 0; i <= 12; i++) {
                row.append($('<td>X</td>').click(() => {
                    let pos = scale.indexOf(base)
                    pos += i
                    add(scale[pos], true)
                }).addClass(neckClass))
                neckClass = 'band'
            }
            $('#neck').append(row)
        })

        render()
    })

    function findLowest(notes) {
        let lowest = scale.length
        notes.forEach(note => {
            const val = scale.indexOf(note)
            if (val < lowest && val >= 0) {
                lowest = val
            }
        })
        return lowest
    }

    function modify(notes, mod) {
        if (mod === 0) {
            return notes.slice() // should always return a copy
        }

        const nnotes = []
        notes.forEach(note => {
            if (note === '|' || note === ' ' || note === '-') {
                nnotes.push(note)
                return
            }

            const letter = note.slice(0, -1)
            let number = parseInt(note.slice(-1), 10)

            number += mod
            nnotes.push(`${letter}${number}`)
        })

        return nnotes
    }

    function render() {
        $('#notes').val(progression.join(' ').replace(/\| /g, '|\n'))
        const id = $('#instrument').val().toLowerCase()
        const neck = instruments[id]

        const result = {}
        let tab = ''

        neck.forEach(base => {
          result[base] = $('<div>' + base + ' | -</div>')
        })

        const modprog = modify(progression, parseInt($('#modify').val(), 10))

        modprog.push('-')

        const li = findLowest(neck)
        const ln = findLowest(modprog)

        $('.tabs').remove()
        $('#tabcontainer').text('')

        if ( li > ln) {
            $('#tabcontainer').text('Cannot print progression, ' + scale[ln] + ' is lower than ' + scale[li])
            return
        }

        const addTab = (base, note, pos) => {
          let posclass = 'inactive'
          if (progPos === pos) {
            posclass = 'active'
          }
          result[base]
            .append($('<span>-</span>').attr('id', base + 'x-' + pos))
            .append(
            $('<span>' + note +'</span>')
              .addClass(posclass)
              .attr('id', base + '-' + pos)
              .click(() => tabClicked(pos))
          )
        }

        modprog.forEach((note, pos) => {
            if (note === ' ' || note === '-') {
                neck.forEach(base => {
                  addTab(base, '-', pos)
                })
                return;
            }

            if (note === '|') {
              const $div = $('<div></div>')
              neck.forEach(base => {
                $div.append(result[base])
                result[base] = $('<div>' + base + ' | -</div>')
              })
              $div.addClass('tabs')
              $('#tabcontainer').append($div)
              return;
            }

            const parts = note.split('+')
            const toAdd = {}
            let blank = '-'
            parts.forEach(note => {
              let candidate = note;
              let offset = 0
              while (neck.indexOf(candidate) < 0 && offset <= 100) {
                  const p = scale.lastIndexOf(candidate)
                  candidate = scale[p - 1]
                  offset ++
              }

              if (offset >= 100) {
                  $('#tabcontainer').text('Cannot print progression, note ' + note + ' could not be found')
                  return
              }

              toAdd[candidate] = '' + offset
              if (toAdd[candidate].length > blank.length) {
                blank = '-'.repeat(toAdd[candidate].length)
              }
            })

            neck.forEach(base => {
              if (toAdd[base]) {
                addTab(base, toAdd[base], pos)
              } else {
                addTab(base, blank, pos)
              }
            })
        })
        const $div = $('<div></div>')
        neck.forEach(base => {
            $div.append(result[base])
        })
        $div.addClass('tabs')
        $('#tabcontainer').append($div)
    }

    </script>
</head>
<body>
    <table id="neck">
    </table>
    <button id = 'space'>Space</button>
    <button id = 'newline'>New line</button>
    <button id = 'remove'>Remove note</button>
    <button id = 'copy'>Copy-paste</button>
    <p>
    <select id = "existing"></select> <button id = "fetch">Fetch</button>
    <p>
    <input id='title' cols=150> <button id = "save">Save</button>
    <p></p>
    <select id='instrument'></select>
    <select id='modify'><option value='-2'>-2<option value='-1'>-1<Option value='0' selected>0</option><option value='1'>+1<option value='2'>+2</select>
    <p></p>
    <div id = "tabcontainer"></div>
    <p></p>
    <textarea id='notes' cols=150 rows=10></textarea>
    <p></p>
    <button id = 'notesParse'>Parse notes</button>
</body>
</html>
